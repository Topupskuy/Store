<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Kunjungan Iframe (Refresh, Pop-up, Salju Numpuk + Audio)</title>
  <style>
    :root{ --popup-bg: rgba(0,0,0,0.0); }
    html, body { margin:0; height:100%; background:#0b0b0b; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; overflow:hidden; }

    #overlay{
      position:fixed; inset:0; display:flex; align-items:center; justify-content:center;
      background:rgba(255,255,255,0.9); z-index:99999; cursor:pointer; text-align:center; padding:24px; line-height:1.4;
    }
    #overlay .inner{ max-width:560px; color:#111; font-size:20px; }
    #overlay .hint{ margin-top:10px; font-size:14px; color:#555; }

    /* Kanvas tumpukan salju (di atas pop-up) */
    #pileCanvas{
      position:fixed; inset:0;
      z-index:1001;           /* > popup (1000) */
      pointer-events:none;
      display:none;           /* aktif setelah klik */
    }
    /* Kanvas salju jatuh (paling atas) */
    #fxCanvas{
      position:fixed; inset:0;
      z-index:1002;           /* > pile (1001), > popup (1000) */
      pointer-events:none;
      display:none;
    }

    #mainFrame{
      position:fixed; inset:0; width:100%; height:100%; border:none; display:none; z-index:1; background:#fff;
    }
    #popupWrap{
      position:fixed; width:99%; height:99%; left: 50%; top: 50%; transform: translate(-50%, -50%);display:none; z-index:1000; background:var(--popup-bg);
      box-sizing:border-box; padding:0.5px 0 0 0.5px;
    }
    #popupFrame{ width:100%; height:100%; border:none; background:transparent; }
    #closePopup{
      position:absolute; top:10px; right:10px; z-index:1001; background:rgba(0,0,0,0.6); color:#fff; border:0; padding:10px 12px; border-radius:10px; cursor:pointer; backdrop-filter:blur(2px);
    }
    #closePopup:hover{ background:rgba(0,0,0,0.8); }
  </style>
</head>
<body>
  <div id="overlay">
    <div class="inner">
      <strong>Sentuh / klik di mana saja untuk memulai.</strong><br/>
      Iframe aktif, pop-up tampil, salju kecil lambat menumpuk Â±10 detik, audio menyala.
      <div class="hint">Browser butuh interaksi pengguna untuk memutar audio & memuat konten tertentu.</div>
    </div>
  </div>

  <!-- Kanvas tumpukan & jatuh -->
  <canvas id="pileCanvas"></canvas>
  <canvas id="fxCanvas"></canvas>

  <!-- Iframe utama -->
  <iframe id="mainFrame" src=""></iframe>

  <!-- Pop-up iframe -->
  <div id="popupWrap">
    <button id="closePopup" title="Tutup pop-up">Tutup Pop-up</button>
    <iframe id="popupFrame" src=""></iframe>
  </div>

  <audio id="bgAudio" loop></audio>

  <script>
    // ====== KONFIGURASI ======
    const mainUrls = ["https://jargonthugconfessed.com/rigxzxmw4?key=1083746753524088ad6b003868517a0e","https://www.effectivegatecpm.com/b3k5sbc7?key=130b6b26063c94e23c6f47c0290113eb"];
    const popupUrl = "https://topupskuy.github.io";
    const refreshIntervalMs = 30_000;

    const audioSrc = ""; // ganti file mp3 kamu
    const audioVolume = 0.1;

    // ====== DOM ======
    const overlay = document.getElementById('overlay');
    const mainFrame = document.getElementById('mainFrame');
    const popupWrap = document.getElementById('popupWrap');
    const popupFrame = document.getElementById('popupFrame');
    const closePopup = document.getElementById('closePopup');
    const fxCanvas = document.getElementById('fxCanvas');      // salju jatuh
    const pileCanvas = document.getElementById('pileCanvas');  // tumpukan salju
    const bgAudio = document.getElementById('bgAudio');

    let started=false, idx=0, ticker=null, rafFall=null, rafPile=null;

    // ====== START AFTER USER GESTURE ======
    function startAll(){
      if(started) return; started=true;
      overlay.style.display='none';
      mainFrame.style.display='block';
      popupWrap.style.display='block';
      fxCanvas.style.display='block';
      pileCanvas.style.display='block';

      bgAudio.src = audioSrc; bgAudio.volume = audioVolume;
      bgAudio.play().catch(()=>{ /* klik lagi jika ditolak */ });

      cycleMain(); popupFrame.src = popupUrl;
      ticker = setInterval(cycleMain, refreshIntervalMs);

      startSnowFX(); // init salju
    }
    ['click','touchstart','keydown','mousemove'].forEach(e=>{
      window.addEventListener(e, startAll, { once:true, passive:true });
    });

    function cycleMain(){
      const url = mainUrls[idx % mainUrls.length];
      const bust = (url.includes('?')?'&':'?')+'t='+Date.now();
      mainFrame.src = url + bust; idx++;
    }
    closePopup.addEventListener('click', ()=>{ popupWrap.style.display = 'none'; });

    // ====== SALJU: JATUH + TUMPUKAN TERPISAH ======
    function startSnowFX(){
      const fallCtx = fxCanvas.getContext('2d');
      const pileCtx = pileCanvas.getContext('2d');
      const DPR = Math.max(1, Math.round(window.devicePixelRatio || 1));

      function resize(){
        const W = Math.floor(window.innerWidth * DPR);
        const H = Math.floor(window.innerHeight * DPR);

        fxCanvas.width = W; fxCanvas.height = H;
        fallCtx.setTransform(DPR,0,0,DPR,0,0);

        pileCanvas.width = W; pileCanvas.height = H;
        pileCtx.setTransform(DPR,0,0,DPR,0,0);
      }
      window.addEventListener('resize', resize);
      resize();

      // Flakes jatuh (kecil & lambat)
      const snowCount = 140;
      const snows = [];
      function makeFlake(){
        return {
          x: Math.random()*window.innerWidth,
          y: -10 - Math.random()*window.innerHeight,
          r: 0.7 + Math.random()*1.6,
          vy: 0.18 + Math.random()*0.45,
          vx: -0.22 + Math.random()*0.44,
          drift: (Math.random()*0.02) + 0.006,
          rot: Math.random()*Math.PI*2,
          shape: ["circle","square","triangle","cross"][ (Math.random()*4)|0 ]
        };
      }
      for(let i=0;i<snowCount;i++) snows.push(makeFlake());

      // Tumpukan (disimpan & digambar di pileCanvas)
      const pile = []; // {x,y,r,shape,rot,created}
      const PILE_LIFETIME = 10_000; // ms

      // --- UTIL BENTUK ---
      function drawFlake(ctx,x,y,r,shape,rot,glow=false,alpha=1){
        ctx.save();
        ctx.globalAlpha = alpha;
        ctx.translate(x,y);
        ctx.rotate(rot||0);
        if(glow){
          ctx.shadowColor = "rgba(255,255,255,0.6)";
          ctx.shadowBlur = 6;
        } else {
          ctx.shadowBlur = 0;
        }
        ctx.fillStyle = "#ffffff";
        ctx.strokeStyle = "#ffffff";
        switch(shape){
          case "circle":
            ctx.beginPath(); ctx.arc(0,0,r,0,Math.PI*2); ctx.fill(); break;
          case "square":
            ctx.beginPath(); ctx.rect(-r, -r, 2*r, 2*r); ctx.fill(); break;
          case "triangle":
            ctx.beginPath();
            const h = r*2.2;
            ctx.moveTo(0,-h/2); ctx.lineTo(-r, h/2); ctx.lineTo(r, h/2);
            ctx.closePath(); ctx.fill(); break;
          case "cross":
            ctx.lineWidth = Math.max(1, r*0.8);
            ctx.beginPath(); ctx.moveTo(-r*1.2,0); ctx.lineTo(r*1.2,0); ctx.stroke();
            ctx.beginPath(); ctx.moveTo(0,-r*1.2); ctx.lineTo(0,r*1.2); ctx.stroke(); break;
        }
        ctx.restore();
      }

      // --- LOOP TUMPUKAN (terpisah, agar persist) ---
      function renderPile(){
        pileCtx.clearRect(0,0,pileCanvas.width,pileCanvas.height);
        const now = performance.now();
        for(let i=pile.length-1;i>=0;i--){
          const p = pile[i];
          const age = now - p.created;
          if(age > PILE_LIFETIME){ pile.splice(i,1); continue; }
          // perlahan memudar mendekati akhir umur
          const fade = Math.max(0.15, 1 - (age/PILE_LIFETIME));
          drawFlake(pileCtx, p.x, p.y, p.r, p.shape, p.rot, true, fade);
        }
        rafPile = requestAnimationFrame(renderPile);
      }

      // --- LOOP JATUH ---
      const wind = { t: 0 };
      function renderFall(){
        fallCtx.clearRect(0,0,fxCanvas.width,fxCanvas.height);
        wind.t += 0.0045;
        const windX = Math.sin(wind.t)*0.22;

        // gambar & update flake jatuh
        for(const s of snows){
          drawFlake(fallCtx, s.x, s.y, s.r, s.shape, s.rot, false, 0.95);

          s.vx += Math.sin((s.y + wind.t*100)*s.drift)*0.0008;
          s.x  += s.vx + windX*0.12;
          s.y  += s.vy;
          s.rot += 0.01 * (s.vx>=0 ? 1 : -1);

          // ketika menyentuh dasar: simpan ke tumpukan (kanvas pile)
          if(s.y >= window.innerHeight - s.r - 1){
            pile.push({
              x: s.x,
              y: window.innerHeight - s.r - 1,
              r: s.r,
              shape: s.shape,
              rot: s.rot,
              created: performance.now()
            });
            // respawn dari atas
            const fresh = makeFlake();
            fresh.x = Math.random()*window.innerWidth;
            fresh.y = -10 - Math.random()*40;
            Object.assign(s, fresh);
          }
          if(s.x < -10) s.x = window.innerWidth + 10;
          if(s.x > window.innerWidth + 10) s.x = -10;
        }
        rafFall = requestAnimationFrame(renderFall);
      }

      renderPile();
      renderFall();
    }

    window.addEventListener('beforeunload', ()=>{
      if(ticker) clearInterval(ticker);
      if(rafFall) cancelAnimationFrame(rafFall);
      if(rafPile) cancelAnimationFrame(rafPile);
      try{ bgAudio.pause(); }catch(e){}
    });
  </script>
</body>
</html>
