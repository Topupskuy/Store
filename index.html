<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Kunjungan Iframe (Refresh, Pop-up, Salju Lambat + Audio)</title>
  <style>
    :root{
      /* Ubah transparansi background pop-up di sini (0 = transparan, 1 = solid) */
      --popup-bg: rgba(0,0,0,0.0);
    }
    html, body {
      margin: 0;
      height: 100%;
      background: #0b0b0b;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      overflow: hidden;
    }

    /* Overlay instruksi awal */
    #overlay {
      position: fixed; inset: 0;
      display: flex; align-items: center; justify-content: center;
      background: rgba(255,255,255,0.9);
      z-index: 99999;
      cursor: pointer;
      text-align: center;
      padding: 24px;
      line-height: 1.4;
    }
    #overlay .inner{
      max-width: 560px;
      color: #111;
      font-size: 20px;
    }
    #overlay .hint{
      margin-top: 10px;
      font-size: 14px;
      color: #555;
    }

    /* Kanvas efek salju (DI ATAS pop-up) */
    #fxCanvas{
      position: fixed; inset: 0;
      z-index: 1002;          /* > popup (1000) */
      pointer-events: none;   /* tidak blok interaksi */
      display: none;          /* aktif setelah klik pertama */
    }

    /* Iframe utama */
    #mainFrame {
      position: fixed; inset: 0;
      width: 100%; height: 100%;
      border: none;
      display: none; /* aktif setelah interaksi */
      z-index: 1;
      background: #fff;
    }

    /* Pop-up iframe (99% x 100%) */
    #popupWrap{
      position: fixed;
      top: 0; left: 0;
      width: 99vw;            /* 99% lebar viewport */
      height: 100vh;
      display: none;          /* aktif setelah interaksi */
      z-index: 1000;          /* di bawah salju */
      background: var(--popup-bg);
      box-sizing: border-box;
      padding: 0.5vw 0 0 0.5vw; /* sedikit ruang agar 99% terlihat */
    }
    #popupFrame{
      width: 100%;
      height: 100%;
      border: none;
      background: transparent;
    }
    /* Tombol tutup pop-up */
    #closePopup{
      position: absolute; top: 10px; right: 10px;
      z-index: 1001;
      background: rgba(0,0,0,0.6);
      color: #fff; border: 0; padding: 10px 12px; border-radius: 10px;
      cursor: pointer;
      backdrop-filter: blur(2px);
    }
    #closePopup:hover{ background: rgba(0,0,0,0.8); }
  </style>
</head>
<body>

  <!-- Overlay awal -->
  <div id="overlay">
    <div class="inner">
      <strong>Sentuh / klik di mana saja untuk memulai.</strong><br/>
      Iframe akan aktif, efek salju lambat & audio akan berjalan, serta pop-up muncul di atas.
      <div class="hint">Kebijakan browser mengharuskan ada interaksi pengguna untuk memutar audio & memuat konten tertentu.</div>
    </div>
  </div>

  <!-- Kanvas efek salju -->
  <canvas id="fxCanvas"></canvas>

  <!-- Iframe utama -->
  <iframe id="mainFrame" src=""></iframe>

  <!-- Pop-up iframe -->
  <div id="popupWrap">
    <button id="closePopup" title="Tutup pop-up">Tutup Pop-up</button>
    <iframe id="popupFrame" src=""></iframe>
  </div>

  <!-- Audio (diinisiasi via JS setelah klik) -->
  <audio id="bgAudio" loop></audio>

  <script>
    // ================== KONFIGURASI ==================
    const mainUrls = [
      "https://www.google.com",
      "https://www.youtube.com"
    ];
    const popupUrl = "https://storeskuy.blogspot.com";
    const refreshIntervalMs = 30_000; // 30 detik

    const audioSrc = "audio.mp3"; // GANTI ke file MP3 milikmu (misal: ./bg.mp3)
    const audioVolume = 0.6;      // 0.0 - 1.0

    // ================== ELEMEN DOM ==================
    const overlay   = document.getElementById('overlay');
    const mainFrame = document.getElementById('mainFrame');
    const popupWrap = document.getElementById('popupWrap');
    const popupFrame= document.getElementById('popupFrame');
    const closePopup= document.getElementById('closePopup');
    const fxCanvas  = document.getElementById('fxCanvas');
    const bgAudio   = document.getElementById('bgAudio');

    let started = false;
    let idx = 0;
    let ticker = null;
    let rafId = null;

    // ================== MULAI SETELAH INTERAKSI ==================
    function startAll(){
      if (started) return;
      started = true;

      overlay.style.display   = 'none';
      mainFrame.style.display = 'block';
      popupWrap.style.display = 'block';
      fxCanvas.style.display  = 'block';

      // load audio
      bgAudio.src = audioSrc;
      bgAudio.volume = audioVolume;
      // play setelah user gesture
      bgAudio.play().catch(()=>{ /* jika gagal, klik lagi area mana pun untuk memulai */ });

      // set urls pertama kali
      cycleMain();
      popupFrame.src = popupUrl;

      // refresh tiap 30 detik, bergantian URL
      ticker = setInterval(cycleMain, refreshIntervalMs);

      // mulai efek salju lambat
      startSnowFX();
    }

    ['click', 'touchstart', 'keydown', 'mousemove'].forEach(evt => {
      window.addEventListener(evt, startAll, { once: true, passive: true });
    });

    // ================== LOGIKA MAIN IFRAME ==================
    function cycleMain(){
      const url = mainUrls[idx % mainUrls.length];
      const bust = (url.includes('?') ? '&' : '?') + 't=' + Date.now();
      // reload dengan cache-buster
      mainFrame.src = url + bust;
      idx++;
    }

    // ================== POP-UP CONTROL ==================
    closePopup.addEventListener('click', () => {
      popupWrap.style.display = 'none';
    });

    // ================== EFEK SALJU LAMBAT + PENUMPUKAN ==================
    function startSnowFX(){
      const ctx = fxCanvas.getContext('2d');
      const DPR = Math.max(1, Math.round(window.devicePixelRatio || 1));

      function resize(){
        fxCanvas.width  = Math.floor(window.innerWidth * DPR);
        fxCanvas.height = Math.floor(window.innerHeight * DPR);
        ctx.setTransform(DPR,0,0,DPR,0,0);
      }
      window.addEventListener('resize', resize);
      resize();

      // Partikel salju kecil & lambat
      const snowCount = 140; // jumlah flake yang jatuh
      const snows = [];
      function makeFlake(){
        return {
          x: Math.random()*window.innerWidth,
          y: -10 - Math.random()*window.innerHeight,    // sebaran awal
          r: 0.6 + Math.random()*1.6,                   // kecil-kecil
          vy: 0.20 + Math.random()*0.55,                // lambat
          vx: -0.25 + Math.random()*0.5,                // sedikit drift
          drift: (Math.random()*0.02) + 0.006,
          rot: Math.random()*Math.PI*2,                 // rotasi untuk bentuk non-lingkaran
          shape: ["circle","square","triangle","cross"][ (Math.random()*4)|0 ]
        };
      }
      for (let i=0;i<snowCount;i++) snows.push(makeFlake());

      // Tumpukan di bawah: bertahan ±10 detik
      const pile = []; // {x,y,r,shape,rot,created}
      const PILE_LIFETIME = 10_000; // ms

      // Menggambar bentuk flake kecil
      function drawFlake(x,y,r,shape,rot){
        ctx.save();
        ctx.translate(x,y);
        ctx.rotate(rot || 0);
        ctx.fillStyle = "#ffffff";
        ctx.strokeStyle = "#ffffff";

        switch(shape){
          case "circle":
            ctx.beginPath(); ctx.arc(0,0,r,0,Math.PI*2); ctx.fill();
            break;
          case "square":
            ctx.beginPath(); ctx.rect(-r, -r, 2*r, 2*r); ctx.fill();
            break;
          case "triangle":
            ctx.beginPath();
            const h = r*2.2;
            ctx.moveTo(0,-h/2);
            ctx.lineTo(-r, h/2);
            ctx.lineTo(r, h/2);
            ctx.closePath(); ctx.fill();
            break;
          case "cross":
            ctx.lineWidth = Math.max(1, r*0.8);
            ctx.beginPath(); ctx.moveTo(-r*1.2,0); ctx.lineTo(r*1.2,0); ctx.stroke();
            ctx.beginPath(); ctx.moveTo(0,-r*1.2); ctx.lineTo(0,r*1.2); ctx.stroke();
            break;
        }
        ctx.restore();
      }

      const wind = { t: 0 };

      function step(ts){
        ctx.clearRect(0,0,fxCanvas.width, fxCanvas.height);

        // Sedikit angin dinamis
        wind.t += 0.0045;
        const windX = Math.sin(wind.t)*0.25;

        // Gambar & update tumpukan (yang sudah mendarat)
        const now = performance.now();
        for (let i = pile.length - 1; i >= 0; i--){
          const p = pile[i];
          // sedikit “settling” visual tipis
          // (opsional: bisa beri fade menjelang akhir umur)
          const age = now - p.created;
          if (age > PILE_LIFETIME){
            pile.splice(i,1);
            continue;
          }
          // opacity turun sedikit mendekati akhir
          const fade = Math.max(0.2, 1 - (age / PILE_LIFETIME));
          ctx.globalAlpha = fade;
          drawFlake(p.x, p.y, p.r, p.shape, p.rot);
          ctx.globalAlpha = 1;
        }

        // Gambar & update flake jatuh
        ctx.globalAlpha = 0.95;
        for (const s of snows){
          drawFlake(s.x, s.y, s.r, s.shape, s.rot);

          // drift & gerak lambat
          s.vx += Math.sin((s.y + wind.t*100)*s.drift)*0.0008;
          s.x += s.vx + windX*0.15;
          s.y += s.vy;

          // rotasi perlahan untuk variasi
          s.rot += 0.01 * (s.vx >= 0 ? 1 : -1);

          // Jika menyentuh dasar, pindahkan ke tumpukan & respawn flake baru
          if (s.y >= window.innerHeight - s.r - 1){
            pile.push({
              x: s.x,
              y: window.innerHeight - s.r - 1,
              r: s.r,
              shape: s.shape,
              rot: s.rot,
              created: now
            });
            // respawn dari atas
            const fresh = makeFlake();
            fresh.x = Math.random()*window.innerWidth;
            fresh.y = -10 - Math.random()*40;
            Object.assign(s, fresh);
          }

          // wrap horizontal
          if (s.x < -10) s.x = window.innerWidth + 10;
          if (s.x > window.innerWidth + 10) s.x = -10;

          // jika (karena resize) melangkahi layar terlalu jauh
          if (s.y < -60) s.y = -20;
        }
        ctx.globalAlpha = 1;

        rafId = requestAnimationFrame(step);
      }
      step();
    }

    // Opsional: hentikan semua saat unload
    window.addEventListener('beforeunload', () => {
      if (ticker) clearInterval(ticker);
      if (rafId) cancelAnimationFrame(rafId);
      try{ bgAudio.pause(); }catch(e){}
    });
  </script>
</body>
</html>
